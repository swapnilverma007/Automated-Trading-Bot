{% extends "base.html" %}
{% load static %}
{% block title %}MA Strategy Backtest{% endblock title %}

{% block head %}
<style>
  .backtest-card {
    transition: all 0.3s ease;
  }
  
  .backtest-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  }
  
  .trade-row:hover {
    background-color: rgba(59, 130, 246, 0.05);
  }
  
  .metric-card {
    transition: all 0.2s ease;
  }
  
  .metric-card:hover {
    transform: translateY(-3px);
  }
  
  /* Loading spinner */
  .spinner {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 3px solid rgba(59, 130, 246, 0.2);
    border-top-color: rgba(59, 130, 246, 1);
    animation: spinner 1s linear infinite;
  }
  
  @keyframes spinner {
    to {transform: rotate(360deg);}
  }
</style>
{% endblock head %}

{% block body %}
<div class="min-h-screen bg-gradient-to-br from-blue-50 to-white py-10">
  <div class="container mx-auto px-4">
    <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-700 mb-6 text-center">Moving Average + ATR Strategy Backtest</h1>
    <p class="text-center text-gray-600 mb-12 max-w-3xl mx-auto">This strategy combines Moving Averages with an ATR-based trailing stop loss to identify potential entry and exit points in trending markets.</p>
    
    <div class="mb-10">
      <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
        <div class="bg-gradient-to-r from-blue-700 to-indigo-800 p-6">
          <h2 class="text-2xl font-semibold text-white">Strategy Configuration</h2>
          <p class="text-blue-100 text-sm">Set your parameters and run the backtest</p>
        </div>
        
        <div class="p-6">
          <form id="backtest-form" class="space-y-6">
            {% csrf_token %}
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <!-- Cryptocurrency Selection -->
              <div>
                <label for="symbol" class="block text-sm font-semibold text-gray-700 mb-2">Cryptocurrency</label>
                <div class="relative rounded-md shadow-sm">
                  <select id="symbol" name="symbol" class="block w-full py-2.5 pl-3 pr-10 text-gray-700 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    {% for crypto in cryptocurrencies %}
                      <option value="{{ crypto.symbol }}">{{ crypto.symbol }}</option>
                    {% endfor %}
                  </select>
                  <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                  </div>
                </div>
              </div>

              <!-- Time Interval -->
              <div>
                <label for="interval" class="block text-sm font-semibold text-gray-700 mb-2">Time Interval</label>
                <div class="relative rounded-md shadow-sm">
                  <select id="interval" name="interval" class="block w-full py-2.5 pl-3 pr-10 text-gray-700 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="1m">1 Minute</option>
                    <option value="5m">5 Minutes</option>
                    <option value="15m">15 Minutes</option>
                    <option value="1h" selected>1 Hour</option>
                    <option value="4h">4 Hours</option>
                    <option value="1d">1 Day</option>
                  </select>
                  <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                  </div>
                </div>
                <p class="text-xs text-blue-600 mt-1 italic">This strategy works best with 1h timeframe</p>
              </div>

              <!-- Start Date -->
              <div>
                <label for="start_date" class="block text-sm font-semibold text-gray-700 mb-2">Start Date</label>
                <div class="relative rounded-md shadow-sm">
                  <input type="date" id="start_date" name="start_date" class="block w-full py-2.5 pl-3 pr-10 text-gray-700 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
              </div>
            </div>

            <div class="mt-8 flex justify-center">
              <button type="submit" id="run-backtest-btn" class="px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-700 text-white text-lg font-semibold rounded-lg shadow-lg hover:from-blue-700 hover:to-indigo-800 transition duration-300 transform hover:-translate-y-1 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                </svg>
                Run Backtest
                <span id="loading-spinner" class="hidden ml-2 spinner w-5 h-5"></span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <!-- Results Section (Initially Hidden) -->
    <div id="results-container" class="hidden space-y-10">
      <!-- Strategy Overview -->
      <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
        <div class="bg-gradient-to-r from-gray-700 to-gray-900 p-6">
          <h2 class="text-2xl font-semibold text-white">Strategy Performance</h2>
          <p class="text-gray-300 text-sm">Key metrics and overview</p>
        </div>
        
        <div class="p-6">
          <!-- Metrics Cards -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="metric-card bg-green-50 p-4 rounded-xl border border-green-100">
              <h3 class="text-sm text-gray-500">Start Value</h3>
              <div class="font-bold text-2xl text-gray-800" id="metric-start-value">-</div>
            </div>
            
            <div class="metric-card bg-blue-50 p-4 rounded-xl border border-blue-100">
              <h3 class="text-sm text-gray-500">End Value</h3>
              <div class="font-bold text-2xl text-gray-800" id="metric-end-value">-</div>
            </div>
            
            <div class="metric-card bg-red-50 p-4 rounded-xl border border-red-100">
              <h3 class="text-sm text-gray-500">Total Return</h3>
              <div class="font-bold text-2xl text-gray-800" id="metric-total-return">-</div>
            </div>
            
            <div class="metric-card bg-purple-50 p-4 rounded-xl border border-purple-100">
              <h3 class="text-sm text-gray-500">Total Trades</h3>
              <div class="font-bold text-2xl text-gray-800" id="metric-total-trades">-</div>
            </div>
          </div>
          
          <!-- Additional Metrics -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="metric-card bg-gray-50 p-4 rounded-xl border border-gray-100">
              <h3 class="text-sm text-gray-500">Win Rate</h3>
              <div class="font-semibold text-xl text-gray-800" id="metric-win-rate">-</div>
            </div>
            
            <div class="metric-card bg-gray-50 p-4 rounded-xl border border-gray-100">
              <h3 class="text-sm text-gray-500">Best Trade</h3>
              <div class="font-semibold text-xl text-gray-800" id="metric-best-trade">-</div>
            </div>
            
            <div class="metric-card bg-gray-50 p-4 rounded-xl border border-gray-100">
              <h3 class="text-sm text-gray-500">Worst Trade</h3>
              <div class="font-semibold text-xl text-gray-800" id="metric-worst-trade">-</div>
            </div>
            
            <div class="metric-card bg-gray-50 p-4 rounded-xl border border-gray-100">
              <h3 class="text-sm text-gray-500">Sharpe Ratio</h3>
              <div class="font-semibold text-xl text-gray-800" id="metric-sharpe-ratio">-</div>
            </div>
            
            <!-- <div class="metric-card bg-gray-50 p-4 rounded-xl border border-gray-100">
              <h3 class="text-sm text-gray-500">Total Loss</h3>
              <div class="font-semibold text-xl text-gray-800" id="metric-total-loss">-</div>
            </div> -->
          </div>
        </div>
      </div>
      
      <!-- Strategy Charts -->
      <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
        <div class="bg-gradient-to-r from-gray-700 to-gray-900 p-6">
          <h2 class="text-2xl font-semibold text-white">Strategy Charts</h2>
          <p class="text-gray-300 text-sm">Visual performance analysis</p>
        </div>
        
        <div class="p-6">
          <div class="grid grid-cols-1 gap-8">
            <!-- Price Chart with Strategy Overlay -->
            <div>
              <h3 class="text-lg font-semibold text-gray-800 mb-4">Price Chart with Strategy Indicators</h3>
              <div class="bg-gray-50 border border-gray-200 rounded-lg">
                <div id="price-chart" style="height: 400px;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.plot.ly/plotly-2.18.0.min.js"></script>
<script>
  // Set default date to 1 month ago
  document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const oneMonthAgo = new Date();
    oneYearAgo.setFullYear(today.getFullYear() - 1);
    
    const defaultDate = oneYearAgo.toISOString().split('T')[0];
    document.getElementById('start_date').value = defaultDate;
  });
  
  // Backtest form submission
  document.getElementById('backtest-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const symbol = document.getElementById('symbol').value;
    const interval = document.getElementById('interval').value;
    const startDate = document.getElementById('start_date').value;
    
    // Show loading spinner
    const loadingSpinner = document.getElementById('loading-spinner');
    const runBacktestBtn = document.getElementById('run-backtest-btn');
    loadingSpinner.classList.remove('hidden');
    runBacktestBtn.disabled = true;
    
    // Hide results container while loading
    document.getElementById('results-container').classList.add('hidden');
    
    // Format date for API request
    const formattedDate = startDate.replace(/-/g, '/');
    
    // Send AJAX request
    fetch('{% url "ma_backtest" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify({
        symbol: symbol,
        interval: interval,
        start_date: formattedDate
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Display results
        displayBacktestResults(data.metrics, data.backtest_data, data.trade_data);
        // Show results container
        document.getElementById('results-container').classList.remove('hidden');
      } else {
        alert('Backtest failed: ' + data.error);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred while running the backtest:' + error.message);
    })
    .finally(() => {
      // Hide loading spinner
      loadingSpinner.classList.add('hidden');
      runBacktestBtn.disabled = false;
    });
  });
  
  function displayBacktestResults(metrics, backtestData, tradeData) {
    // Update metrics
    document.getElementById('metric-start-value').textContent = metrics.start_value.toFixed(2);
    document.getElementById('metric-end-value').textContent = metrics.end_value.toFixed(2);
    document.getElementById('metric-total-return').textContent = formatPercentage(metrics.total_return);
    document.getElementById('metric-total-trades').textContent = metrics.total_trades.toFixed(2);
    document.getElementById('metric-win-rate').textContent = formatPercentage(metrics.win_rate);
    document.getElementById('metric-best-trade').textContent = formatPercentage(metrics.best_trade);
    document.getElementById('metric-worst-trade').textContent = formatPercentage(metrics.worst_trade);
    document.getElementById('metric-sharpe-ratio').textContent = metrics.sharpe_ratio.toFixed(2);

    // Create charts
    createPriceChart(backtestData);
  }
  
  function formatPercentage(value) {
    if (value === null || value === undefined) return 'N/A';
    return (value).toFixed(2) + '%';
  }
  
  function createPriceChart(data) {
    const prices = {
      x: data.dates,
      y: data.close_prices,
      type: 'scatter',
      mode: 'lines',
      name: 'Price',
      line: {
        color: '#4b5563',
        width: 1
      }
    };
    
    const sma20 = {
      x: data.dates,
      y: data.sma20,
      type: 'scatter',
      mode: 'lines',
      name: 'SMA 20',
      line: {
        color: '#3b82f6',
        width: 1.5
      }
    };
    
    const sma50 = {
      x: data.dates,
      y: data.sma50,
      type: 'scatter',
      mode: 'lines',
      name: 'SMA 50',
      line: {
        color: '#ef4444',
        width: 1.5
      }
    };
    
    const trailingStop = {
      x: data.dates,
      y: data.trailing_stop,
      type: 'scatter',
      mode: 'lines',
      name: 'ATR Trailing Stop',
      line: {
        color: '#8b5cf6',
        width: 1.5,
        dash: 'dash'
      }
    };
    
    const layout = {
      margin: {t: 20, r: 10, l: 40, b: 40},
      legend: {orientation: 'h', y: 1.1},
      xaxis: {
        rangeslider: {visible: false},
        type: 'date'
      },
      yaxis: {
        title: 'Price',
        autorange: true,
        fixedrange: false
      },
      plot_bgcolor: '#F9FAFB',
      paper_bgcolor: '#F9FAFB',
      hovermode: 'closest'
    };
    
    Plotly.newPlot('price-chart', [prices, sma20, sma50, trailingStop], layout);
  }
  
  function createEquityChart(data) {
    const equity = {
      x: data.dates,
      y: data.equity_curve,
      type: 'scatter',
      fill: 'tozeroy',
      name: 'Equity',
      line: {
        color: '#10B981',
        width: 1
      },
      fillcolor: 'rgba(16, 185, 129, 0.1)'
    };
    
    const layout = {
      margin: {t: 20, r: 10, l: 40, b: 40},
      xaxis: {
        type: 'date'
      },
      yaxis: {
        title: 'Equity ($)',
      },
      showlegend: false,
      plot_bgcolor: '#F9FAFB',
      paper_bgcolor: '#F9FAFB'
    };
    
    Plotly.newPlot('equity-chart', [equity], layout);
  }
  
  function createDrawdownChart(data) {
    const drawdown = {
      x: data.dates,
      y: data.drawdown_curve.map(d => -d), // Convert to negative values for better visualization
      type: 'scatter',
      fill: 'tozeroy',
      name: 'Drawdown',
      line: {
        color: '#EF4444',
        width: 1
      },
      fillcolor: 'rgba(239, 68, 68, 0.1)'
    };
    
    const layout = {
      margin: {t: 20, r: 10, l: 40, b: 40},
      xaxis: {
        type: 'date'
      },
      yaxis: {
        title: 'Drawdown (%)',
        autorange: 'reversed' // Reverse the y-axis to show drawdown going down
      },
      showlegend: false,
      plot_bgcolor: '#F9FAFB',
      paper_bgcolor: '#F9FAFB'
    };
    
    Plotly.newPlot('drawdown-chart', [drawdown], layout);
  }
  
  function populateTradeList(trades) {
    const tradeList = document.getElementById('trade-list');
    tradeList.innerHTML = '';
    
    trades.forEach(trade => {
      const row = document.createElement('tr');
      row.className = 'trade-row hover:bg-blue-50';
      
      const isProfitable = trade.pnl > 0;
      const pnlClass = isProfitable ? 'text-green-600' : 'text-red-600';
      const returnClass = isProfitable ? 'text-green-600' : 'text-red-600';
      
      row.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${trade.entry_time}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${trade.exit_time}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">$${trade.entry_price.toFixed(4)}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">$${trade.exit_price.toFixed(4)}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${pnlClass}">$${trade.pnl.toFixed(2)}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${returnClass}">${(trade.return * 100).toFixed(2)}%</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${trade.duration.toFixed(1)}</td>
      `;
      
      tradeList.appendChild(row);
    });
  }
</script>
{% endblock body %}