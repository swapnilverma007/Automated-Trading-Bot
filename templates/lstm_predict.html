{% extends "base.html" %}
{% load static %}
{% block title %}LSTM Price Prediction{% endblock title %}

{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
<style>
  .prediction-badge {
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }
  
  .loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 100;
    backdrop-filter: blur(2px);
  }
</style>
{% endblock head %}

{% block body %}
<div class="min-h-screen bg-gradient-to-br from-blue-50 to-white py-10">
  <div class="container mx-auto px-4">
    <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-indigo-700 mb-6 text-center">LSTM Neural Network Prediction</h1>
    <p class="text-center text-gray-600 mb-10 max-w-2xl mx-auto">Advanced deep learning model that predicts future cryptocurrency prices based on historical patterns.</p>
    
    <div class="bg-white rounded-2xl shadow-xl overflow-hidden mb-8">
      <div class="bg-gradient-to-r from-purple-600 to-indigo-700 p-6">
        <div class="flex flex-wrap items-center justify-between">
          <div>
            <h2 class="text-2xl font-semibold text-white">Price Prediction</h2>
            <p class="text-purple-100 text-sm">Using Long Short-Term Memory neural networks</p>
          </div>
        </div>
      </div>

      <div class="p-6">
        <!-- Cryptocurrency Selection Form -->
        <form id="prediction-form" class="mb-6">
          {% csrf_token %}
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="md:col-span-3">
              <label for="symbol" class="block text-sm font-semibold text-gray-700 mb-2">Cryptocurrency</label>
              <div class="relative rounded-md shadow-sm">
                <select id="symbol" name="symbol" class="block w-full py-2.5 pl-3 pr-10 text-gray-700 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                  {% for crypto in cryptocurrencies %}
                    <option value="{{ crypto.symbol }}" {% if crypto.symbol not in available_models %}disabled{% endif %}>
                      {{ crypto.symbol }} {% if crypto.symbol not in available_models %}(Coming Soon){% endif %}
                    </option>
                  {% endfor %}
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                  <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                  </svg>
                </div>
              </div>
            </div>
            
            <div class="md:col-span-1 flex items-end">
              <button type="button" id="predict-button" class="w-full py-2.5 px-4 bg-gradient-to-r from-purple-600 to-indigo-700 text-white text-lg font-semibold rounded-lg shadow-md hover:from-purple-700 hover:to-indigo-800 transition duration-300">
                Predict
              </button>
            </div>
          </div>
        </form>

        <!-- Prediction Results -->
        <div id="prediction-result" class="hidden">
          <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-5 mb-6">
            <div class="flex flex-wrap items-center justify-between">
              <div>
                <h3 class="text-lg font-semibold text-gray-800">Prediction Results</h3>
                <p class="text-gray-600 text-sm">Next hour price forecast</p>
              </div>
              <span id="prediction-badge" class="prediction-badge inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-indigo-100 text-indigo-800">
                Prediction
              </span>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-4">
              <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100">
                <div class="text-sm text-gray-500 mb-1">Current Price</div>
                <div id="current-price" class="text-xl font-semibold text-gray-800">-</div>
              </div>
              
              <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100">
                <div class="text-sm text-gray-500 mb-1">Predicted Next Price</div>
                <div id="predicted-price" class="text-xl font-semibold text-purple-600">-</div>
              </div>
              
              <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100">
                <div class="text-sm text-gray-500 mb-1">Prediction Direction</div>
                <div id="prediction-direction" class="text-xl font-semibold">-</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Price Chart -->
        <div id="chart-container" class="hidden">
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-1 relative">
            <div id="chart" class="w-full" style="height: 400px;"></div>
            
            <div id="loading-overlay" class="loading-overlay hidden">
              <div class="flex flex-col items-center">
                <svg class="animate-spin h-10 w-10 text-purple-600 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-purple-600 font-medium">Running LSTM model...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Model Information Section -->
    <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
      <div class="bg-gradient-to-r from-gray-700 to-gray-900 p-6">
        <h2 class="text-2xl font-semibold text-white">About LSTM Neural Networks</h2>
        <p class="text-gray-300 text-sm">Understanding the technology behind the predictions</p>
      </div>
      
      <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <div>
            <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              What is an LSTM?
            </h3>
            <p class="text-gray-600">Long Short-Term Memory (LSTM) networks are a specialized type of recurrent neural network capable of learning long-term dependencies. They're particularly good at processing sequential data like time series, which makes them ideal for predicting cryptocurrency price movements based on historical patterns.</p>
          </div>
          
          <div>
            <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Limitations
            </h3>
            <p class="text-gray-600">While LSTM models can identify complex patterns in historical data, cryptocurrency markets are influenced by many external factors that can't be predicted, such as regulatory news, market sentiment, and macroeconomic events. The predictions should be used as one of many tools in your trading strategy, not as the sole basis for decisions.</p>
          </div>
        </div>
        
        <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-100">
          <div class="flex items-start">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-600 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <p class="text-sm text-blue-800">
              <strong>Note:</strong> This tool predicts the price for the next 1-hour candle. The model is trained on historical hourly data and updated regularly to maintain accuracy. More cryptocurrencies will be added soon!
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/lightweight-charts@3.5.0/dist/lightweight-charts.standalone.production.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const predictButton = document.getElementById('predict-button');
  const symbolSelect = document.getElementById('symbol');
  const predictionResult = document.getElementById('prediction-result');
  const chartContainer = document.getElementById('chart-container');
  const loadingOverlay = document.getElementById('loading-overlay');
  let chart;

  // Initialize chart
  function initChart() {
    const chartElement = document.getElementById('chart');
    
    if (chart) {
      // Clear previous chart
      chartElement.innerHTML = '';
    }
    
    chart = LightweightCharts.createChart(chartElement, {
      width: chartElement.clientWidth,
      height: chartElement.clientHeight,
      layout: {
        backgroundColor: '#ffffff',
        textColor: '#333',
        fontSize: 12,
        fontFamily: 'Inter, sans-serif',
      },
      grid: {
        vertLines: { color: 'rgba(225, 225, 225, 0.3)' },
        horzLines: { color: 'rgba(225, 225, 225, 0.3)' },
      },
      crosshair: {
        mode: LightweightCharts.CrosshairMode.Normal,
        vertLine: {
          width: 1,
          color: 'rgba(99, 102, 241, 0.5)',
          style: LightweightCharts.LineStyle.Solid,
        },
        horzLine: {
          width: 1,
          color: 'rgba(99, 102, 241, 0.5)',
          style: LightweightCharts.LineStyle.Solid,
          labelBackgroundColor: 'rgba(99, 102, 241, 0.8)',
        },
      },
      timeScale: {
        borderColor: 'rgba(225, 225, 225, 0.8)',
        timeVisible: true,
      },
      rightPriceScale: {
        borderColor: 'rgba(225, 225, 225, 0.8)',
      },
    });

    // Handle resize
    window.addEventListener('resize', () => {
      chart.resize(chartElement.clientWidth, chartElement.clientHeight);
    });
  }
  
  // Make prediction
  async function runPrediction() {
    const symbol = symbolSelect.value;
    
    // Check if a valid symbol is selected
    if (!symbol || symbol === "") {
      alert("Please select a cryptocurrency");
      return;
    }
    
    // Show loading state
    loadingOverlay.classList.remove('hidden');
    chartContainer.classList.remove('hidden');
    
    try {
      const response = await fetch('/run_lstm_prediction/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCsrfToken(),
        },
        body: JSON.stringify({ symbol }),
      });
      
      const data = await response.json();
      
      // Hide loading state
      loadingOverlay.classList.add('hidden');
      
      if (!data.success) {
        // Handle error
        alert(data.error || "Failed to run prediction");
        return;
      }
      
      // Process and display results
      displayResults(data);
    } catch (error) {
      console.error("Error running prediction:", error);
      loadingOverlay.classList.add('hidden');
      alert("Error running prediction. Please try again.");
    }
  }
  
  // Display prediction results
  function displayResults(data) {
    const currentPrice = parseFloat(data.current_price).toFixed(2);
    const predictedPrice = parseFloat(data.predicted_price).toFixed(2);
    const priceDifference = parseFloat(predictedPrice - currentPrice).toFixed(2);
    const percentChange = ((priceDifference / currentPrice) * 100).toFixed(2);
    const direction = priceDifference >= 0 ? 'UP' : 'DOWN';
    
    // Update results display
    document.getElementById('current-price').textContent = `$${currentPrice}`;
    document.getElementById('predicted-price').textContent = `$${predictedPrice}`;
    
    const directionElement = document.getElementById('prediction-direction');
    if (direction === 'UP') {
      directionElement.innerHTML = `<span class="text-green-600 flex items-center">UP <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" /></svg></span>`;
      document.getElementById('prediction-badge').className = 'prediction-badge inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800';
    } else {
      directionElement.innerHTML = `<span class="text-red-600 flex items-center">DOWN <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" /></svg></span>`;
      document.getElementById('prediction-badge').className = 'prediction-badge inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800';
    }
    
    // Show results container
    predictionResult.classList.remove('hidden');
    
    // Initialize chart
    initChart();
    
    // Plot chart data
    const chartData = data.chart_data.map(item => ({
      time: item.timestamp,
      open: parseFloat(item.open),
      high: parseFloat(item.high),
      low: parseFloat(item.low),
      close: parseFloat(item.close),
      value: parseFloat(item.close),
    }));
    
    // Create candlestick series
    const candlestickSeries = chart.addCandlestickSeries({
      upColor: '#4ade80',
      downColor: '#f87171',
      borderUpColor: '#22c55e',
      borderDownColor: '#ef4444',
      wickUpColor: '#22c55e',
      wickDownColor: '#ef4444',
    });
    
    candlestickSeries.setData(chartData);
    
    // Add prediction marker
    const markerSeries = chart.addLineSeries({
      color: '#8b5cf6',
      lineWidth: 2,
      lineStyle: LightweightCharts.LineStyle.Dotted,
      lastValueVisible: false,
      priceLineVisible: false,
    });
    
    // Add prediction point
    const lastTimestamp = data.last_timestamp;
    const predictionTime = data.prediction_time;
    
    markerSeries.setMarkers([
      {
        time: predictionTime,
        position: 'aboveBar',
        color: direction === 'UP' ? '#22c55e' : '#ef4444',
        shape: 'circle',
        text: `Prediction: $${predictedPrice}`,
      }
    ]);
    
    // Connect the last known price with the prediction
    const lineSeries = chart.addLineSeries({
      color: '#8b5cf6',
      lineWidth: 2,
      lineStyle: LightweightCharts.LineStyle.Dashed,
      lastValueVisible: false,
      priceLineVisible: false,
    });
    
    lineSeries.setData([
      { time: lastTimestamp, value: parseFloat(currentPrice) },
      { time: predictionTime, value: parseFloat(predictedPrice) }
    ]);
    
    // Fit content
    chart.timeScale().fitContent();
  }
  
  // Get CSRF token from cookies
  function getCsrfToken() {
    const cookieValue = document.cookie
      .split('; ')
      .find(function(row) {
        return row.startsWith('csrftoken=');
      });
    return cookieValue ? cookieValue.split('=')[1] : '';
  }
  
  // Add event listeners
  predictButton.addEventListener('click', runPrediction);
  
  // Filter available models in dropdown
  const availableModels = JSON.parse('{{ available_models_json|safe }}');
  
  // Don't add "(Coming Soon)" text in JavaScript since it's already in the template
  Array.from(symbolSelect.options).forEach(function(option) {
    if (!availableModels.includes(option.value)) {
      option.disabled = true;
      // Remove this line to prevent duplicate "Coming Soon" text
      // option.text += " (Coming Soon)";
    }
  });
  
  // Set default selection to first available model
  if (availableModels.length > 0) {
    symbolSelect.value = availableModels[0];
  }
});
</script>
{% endblock body %}