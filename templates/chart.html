{% extends "base.html" %}
{% load static %}
{% block title %}Crypto Visualization{% endblock title %}

{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
{% endblock head %}

{% block body %}
<div class="min-h-screen bg-gradient-to-br from-blue-50 to-white py-10">
  <div class="container mx-auto px-4">
    <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-700 mb-6 text-center">Market Visualization</h1>
    <p class="text-center text-gray-600 mb-10 max-w-2xl mx-auto">Advanced technical analysis tools to help you make informed trading decisions with real-time data visualization.</p>
    
    <div class="bg-white rounded-2xl shadow-xl overflow-hidden mb-8">
      <div class="bg-gradient-to-r from-blue-700 to-indigo-800 p-6">
        <div class="flex flex-wrap items-center justify-between">
          <div>
            <h2 class="text-2xl font-semibold text-white">{{ symbol }} - {{ interval }} Chart</h2>
            <p class="text-blue-100 text-sm">Real-time price action and technical indicators</p>
          </div>
          <div class="mt-2 md:mt-0 flex items-center">
            <span class="bg-blue-900/50 text-blue-100 py-1 px-3 rounded-lg text-sm flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
              </svg>
              Live Data
            </span>
          </div>
        </div>
      </div>

      <div class="p-6">
        <!-- Chart Controls -->
        <form method="GET" action="" class="mb-6">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Cryptocurrency Selection -->
            <div>
              <label for="symbol" class="block text-sm font-semibold text-gray-700 mb-2">Cryptocurrency</label>
              <div class="relative rounded-md shadow-sm">
                <select id="symbol" name="symbol" class="block w-full py-2.5 pl-3 pr-10 text-gray-700 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="this.form.submit()">
                  {% for crypto in cryptocurrencies %}
                    <option value="{{ crypto.symbol }}" {% if symbol == crypto.symbol %}selected{% endif %}>
                      {{ crypto.symbol }}
                    </option>
                  {% endfor %}
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                  <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                  </svg>
                </div>
              </div>
            </div>

            <!-- Time Interval -->
            <div>
              <label for="interval" class="block text-sm font-semibold text-gray-700 mb-2">Time Interval</label>
              <div class="relative rounded-md shadow-sm">
                <select id="interval" name="interval" class="block w-full py-2.5 pl-3 pr-10 text-gray-700 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="this.form.submit()">
                  <option value="1m" {% if interval == '1m' %}selected{% endif %}>1 Minute</option>
                  <option value="5m" {% if interval == '5m' %}selected{% endif %}>5 Minutes</option>
                  <option value="15m" {% if interval == '15m' %}selected{% endif %}>15 Minutes</option>
                  <option value="1h" {% if interval == '1h' %}selected{% endif %}>1 Hour</option>
                  <option value="1d" {% if interval == '1d' %}selected{% endif %}>1 Day</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                  <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                  </svg>
                </div>
              </div>
            </div>

            <!-- Technical Indicator -->
            <div>
              <label for="indicator" class="block text-sm font-semibold text-gray-700 mb-2">Technical Indicator</label>
              <div class="relative rounded-md shadow-sm">
                <select id="indicator" name="indicator" class="block w-full py-2.5 pl-3 pr-10 text-gray-700 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="this.form.submit()">
                  <option value="" {% if not indicator %}selected{% endif %}>None</option>
                  <option value="SMA" {% if indicator == 'SMA' %}selected{% endif %}>Moving Averages (SMA)</option>
                  <option value="RSI" {% if indicator == 'RSI' %}selected{% endif %}>Relative Strength Index (RSI)</option>
                  <option value="ATR_TS" {% if indicator == 'ATR_TS' %}selected{% endif %}>ATR Trailing Stop</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                  <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                  </svg>
                </div>
              </div>
            </div>
          </div>
        </form>

        <!-- Chart Legend -->
        {% if indicator == 'SMA' %}
        <div class="flex flex-wrap gap-4 mb-4">
          <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
            <span class="w-3 h-3 bg-blue-500 rounded-full mr-1"></span>
            SMA 20
          </span>
          <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
            <span class="w-3 h-3 bg-red-500 rounded-full mr-1"></span>
            SMA 50
          </span>
        </div>
        {% endif %}

        <!-- Charts Container -->
        <div class="bg-gray-50 border border-gray-200 rounded-lg p-1">
          <div id="chart-wrapper" class="relative w-full" style="height: 600px;">
            <div id="chart" class="rounded-lg w-full h-[70%]"></div>
            <div id="rsi-chart" class="rounded-lg w-full h-[30%]"></div>
          </div>
        </div>

        <!-- Chart Information -->
        <div class="mt-4 grid grid-cols-1 md:grid-cols-4 gap-3 text-center">
          <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
            <div class="text-sm text-gray-500">Open</div>
            <div class="font-semibold text-gray-800" id="open-price">-</div>
          </div>
          <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
            <div class="text-sm text-gray-500">Close</div>
            <div class="font-semibold text-gray-800" id="close-price">-</div>
          </div>
          <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
            <div class="text-sm text-gray-500">High</div>
            <div class="font-semibold text-gray-800" id="high-price">-</div>
          </div>
          <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
            <div class="text-sm text-gray-500">Low</div>
            <div class="font-semibold text-gray-800" id="low-price">-</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/lightweight-charts@3.5.0/dist/lightweight-charts.standalone.production.js"></script>
<script>
    // Parse data from backend
    const chartData = JSON.parse('{{ chart_data|escapejs }}');
    const sma20Data = JSON.parse('{{ sma20_data|escapejs }}');
    const sma50Data = JSON.parse('{{ sma50_data|escapejs }}');
    const rsiData = JSON.parse('{{ rsi_data|escapejs }}');
    const atrTsData = JSON.parse('{{ atr_ts_data|escapejs }}');

    // Chart configuration
    const chartOptions = {
        layout: {
            backgroundColor: '#ffffff',
            textColor: '#333',
            fontSize: 12,
            fontFamily: 'Inter, sans-serif',
        },
        grid: {
            vertLines: {
                color: 'rgba(225, 225, 225, 0.3)',
            },
            horzLines: {
                color: 'rgba(225, 225, 225, 0.3)',
            },
        },
        crosshair: {
            mode: LightweightCharts.CrosshairMode.Normal,
            vertLine: {
                width: 1,
                color: 'rgba(99, 102, 241, 0.5)',
                style: LightweightCharts.LineStyle.Solid,
            },
            horzLine: {
                width: 1,
                color: 'rgba(99, 102, 241, 0.5)',
                style: LightweightCharts.LineStyle.Solid,
                labelBackgroundColor: 'rgba(99, 102, 241, 0.8)',
            },
        },
        timeScale: {
            borderColor: 'rgba(225, 225, 225, 0.8)',
            timeVisible: true,
        },
        rightPriceScale: {
            borderColor: 'rgba(225, 225, 225, 0.8)',
        },
    };

    // Initialize main chart
    const chartContainer = document.getElementById('chart');
    const chart = LightweightCharts.createChart(chartContainer, {
        width: chartContainer.clientWidth,
        height: chartContainer.clientHeight,
        ...chartOptions
    });

    // Add candlestick series
    const candlestickSeries = chart.addCandlestickSeries({
        upColor: '#4ade80',
        downColor: '#f87171',
        borderUpColor: '#22c55e',
        borderDownColor: '#ef4444',
        wickUpColor: '#22c55e',
        wickDownColor: '#ef4444',
    });
    
    candlestickSeries.setData(chartData.map(item => ({
        time: item.timestamp,
        open: item.open,
        high: item.high,
        low: item.low,
        close: item.close,
    })));

    // Display last price info
    if (chartData.length > 0) {
        const lastCandle = chartData[chartData.length - 1];
        document.getElementById('open-price').textContent = lastCandle.open.toFixed(2);
        document.getElementById('close-price').textContent = lastCandle.close.toFixed(2);
        document.getElementById('high-price').textContent = lastCandle.high.toFixed(2);
        document.getElementById('low-price').textContent = lastCandle.low.toFixed(2);
    }

    // Add SMA indicators if selected
    if (sma20Data.length > 0) {
        const sma20Series = chart.addLineSeries({
            color: 'rgba(59, 130, 246, 1)', // blue
            lineWidth: 2,
            priceLineVisible: false,
        });
        sma20Series.setData(sma20Data.map(item => ({
            time: item.timestamp,
            value: item.SMA20,
        })));
    }

    if (sma50Data.length > 0) {
        const sma50Series = chart.addLineSeries({
            color: 'rgba(239, 68, 68, 1)', // red
            lineWidth: 2,
            priceLineVisible: false,
        });
        sma50Series.setData(sma50Data.map(item => ({
            time: item.timestamp,
            value: item.SMA50,
        })));
    }

    // Add RSI indicator if selected
    if (rsiData.length > 0) {
        const rsiChartContainer = document.getElementById('rsi-chart');
        const rsiChart = LightweightCharts.createChart(rsiChartContainer, {
            width: rsiChartContainer.clientWidth,
            height: rsiChartContainer.clientHeight,
            layout: chartOptions.layout,
            grid: chartOptions.grid,
            timeScale: {
                visible: false,
            },
            rightPriceScale: {
                borderColor: 'rgba(225, 225, 225, 0.8)',
            },
        });

        const rsiSeries = rsiChart.addLineSeries({
            color: 'rgba(124, 58, 237, 1)', // purple
            lineWidth: 2,
            priceLineVisible: false,
        });
        
        rsiSeries.setData(rsiData.map(item => ({
            time: item.timestamp,
            value: item.RSI,
        })));

        // Add overbought/oversold levels
        const oversoldSeries = rsiChart.addLineSeries({
            color: 'rgba(209, 213, 219, 0.5)', // gray
            lineWidth: 1,
            lineStyle: LightweightCharts.LineStyle.Dashed,
            priceLineVisible: false,
        });
        
        const overboughtSeries = rsiChart.addLineSeries({
            color: 'rgba(209, 213, 219, 0.5)', // gray
            lineWidth: 1,
            lineStyle: LightweightCharts.LineStyle.Dashed,
            priceLineVisible: false,
        });
        
        oversoldSeries.setData(rsiData.map(item => ({
            time: item.timestamp,
            value: 30,
        })));
        
        overboughtSeries.setData(rsiData.map(item => ({
            time: item.timestamp,
            value: 70,
        })));

        // Sync charts time scale
        chart.timeScale().subscribeVisibleTimeRangeChange(timeRange => {
            rsiChart.timeScale().setVisibleRange(timeRange);
        });

        window.addEventListener('resize', () => {
            rsiChart.resize(rsiChartContainer.clientWidth, rsiChartContainer.clientHeight);
        });

        // Add RSI indicator label
        rsiChart.applyOptions({
            overlayPriceScales: {
                rsiLabel: {
                    scaleMargins: {
                        top: 0.1,
                        bottom: 0.1,
                    },
                },
            },
        });
    }

    // Add ATR Trailing Stop if selected
    if (atrTsData.length > 0) {
        const tsSeries = chart.addLineSeries({
            lineWidth: 2,
            lastValueVisible: false,
            priceLineVisible: false,
        });

        tsSeries.setData(atrTsData.map(item => ({
            time: item.timestamp,
            value: item.TS,
            color: item.Color,
        })));
    }

    // Handle resize
    window.addEventListener('resize', () => {
        chart.resize(chartContainer.clientWidth, chartContainer.clientHeight);
    });
</script>
{% endblock body %}